{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="/static/css/home.css">
{% endblock %}

{% block content %}
<section class="hero">
    <h1>Telegram Music</h1>
    <p>–°–ª—É—à–∞–π –ª—é–±—É—é –º—É–∑—ã–∫—É –±–µ—Å–ø–ª–∞—Ç–Ω–æ</p>
    
    <!-- –ü–æ–∏—Å–∫ –º—É–∑—ã–∫–∏ -->
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="–ù–∞–π–¥–∏ –ª—é–±—É—é –º—É–∑—ã–∫—É..." class="search-input">
        <button onclick="searchMusic()" class="search-btn">–ü–æ–∏—Å–∫</button>
    </div>
</section>

<!-- –ü–æ–ø—É–ª—è—Ä–Ω–∞—è –º—É–∑—ã–∫–∞ -->
<section class="popular-section">
    <h2 class="section-title">üéµ –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç—Ä–µ–∫–∏</h2>
    <div id="popularMusic" class="music-grid">
        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –º—É–∑—ã–∫–∏...</div>
    </div>
</section>

<!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
<section id="searchSection" class="search-section" style="display: none;">
    <h2 class="section-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</h2>
    <div id="searchResults" class="music-grid"></div>
</section>

<!-- –ê—É–¥–∏–æ–ø–ª–µ–µ—Ä -->
<div id="audioPlayer" class="audio-player" style="display: none;">
    <audio id="audioElement" controls class="audio-element">
        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç—ã.
    </audio>
    <div id="nowPlaying" class="now-playing"></div>
</div>

<script>
// –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç—Ä–µ–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
const popularQueries = [
    "lofi hip hop radio",
    "chill music 2024", 
    "pop hits 2024",
    "rock classics",
    "jazz relaxing music"
];

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ø—É–ª—è—Ä–Ω–æ–π –º—É–∑—ã–∫–∏
async function loadPopularMusic() {
    try {
        const container = document.getElementById('popularMusic');
        container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ø—É–ª—è—Ä–Ω–æ–π –º—É–∑—ã–∫–∏...</div>';
        
        // –ò—â–µ–º –ø–æ –ø–æ–ø—É–ª—è—Ä–Ω—ã–º –∑–∞–ø—Ä–æ—Å–∞–º
        let allResults = [];
        for (const query of popularQueries.slice(0, 2)) { // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 2 –∑–∞–ø—Ä–æ—Å–∞
            const response = await fetch(`/music/search?query=${encodeURIComponent(query)}`);
            const data = await response.json();
            allResults = allResults.concat(data.results.slice(0, 5)); // –ü–æ 5 —Ç—Ä–µ–∫–æ–≤ —Å –∫–∞–∂–¥–æ–≥–æ
        }
        
        // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
        const uniqueResults = allResults.filter((track, index, self) =>
            index === self.findIndex(t => t.id === track.id)
        );
        
        if (uniqueResults.length === 0) {
            container.innerHTML = '<div class="no-results">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º—É–∑—ã–∫—É</div>';
            return;
        }
        
        let html = '';
        uniqueResults.slice(0, 15).forEach(song => { // –ú–∞–∫—Å–∏–º—É–º 15 —Ç—Ä–µ–∫–æ–≤
            html += createSongCard(song);
        });
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading popular music:', error);
        document.getElementById('popularMusic').innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º—É–∑—ã–∫–∏</div>';
    }
}

// –ü–æ–∏—Å–∫ –º—É–∑—ã–∫–∏
async function searchMusic() {
    const query = document.getElementById('searchInput').value;
    if (!query) return;
    
    const resultsDiv = document.getElementById('searchResults');
    const searchSection = document.getElementById('searchSection');
    
    resultsDiv.innerHTML = '<div class="loading">–ò—â–µ–º –º—É–∑—ã–∫—É...</div>';
    searchSection.style.display = 'block';
    
    try {
        const response = await fetch(`/music/search?query=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        if (data.results.length === 0) {
            resultsDiv.innerHTML = '<div class="no-results">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
            return;
        }
        
        let html = '';
        data.results.forEach(song => {
            html += createSongCard(song);
        });
        
        resultsDiv.innerHTML = html;
        
    } catch (error) {
        console.error('Search error:', error);
        resultsDiv.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç—Ä–µ–∫–∞
function createSongCard(song) {
    const safeTitle = song.title.replace(/'/g, "\\'").replace(/"/g, '\\"');
    const safeArtist = song.artist.replace(/'/g, "\\'").replace(/"/g, '\\"');
    
    return `
        <div class="song-card" onclick="playSong('${song.id}', '${safeArtist}', '${safeTitle}')">
            <div class="song-image">
                ${song.thumbnail ? 
                    `<img src="${song.thumbnail}" alt="${song.title}" class="song-thumbnail">` :
                    `<div class="song-placeholder">üéµ</div>`
                }
            </div>
            <div class="song-info">
                <h3 class="song-title">${song.title}</h3>
                <p class="song-artist">${song.artist}</p>
                <div class="song-meta">
                    <span class="duration">${formatDuration(song.duration)}</span>
                    ${song.view_count ? `<span class="views">üëÅ ${formatViews(song.view_count)}</span>` : ''}
                </div>
            </div>
            <button class="play-btn">‚ñ∂</button>
        </div>
    `;
}

// –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –º—É–∑—ã–∫–∏
function playSong(videoId, artist, title) {
    const audioPlayer = document.getElementById('audioPlayer');
    const audioElement = document.getElementById('audioElement');
    const nowPlaying = document.getElementById('nowPlaying');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–µ–µ—Ä
    audioPlayer.style.display = 'block';
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –º—É–∑—ã–∫–∏
    audioElement.src = `/music/stream/${videoId}`;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –∏–≥—Ä–∞–µ—Ç
    nowPlaying.textContent = `–°–µ–π—á–∞—Å –∏–≥—Ä–∞–µ—Ç: ${artist} - ${title}`;
    
    // –ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
    audioElement.play().catch(e => console.log('Autoplay blocked:', e));
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
function formatDuration(seconds) {
    if (!seconds) return '--:--';
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
function formatViews(views) {
    if (views >= 1000000) {
        return (views / 1000000).toFixed(1) + 'M';
    } else if (views >= 1000) {
        return (views / 1000).toFixed(1) + 'K';
    }
    return views;
}

// –ü–æ–∏—Å–∫ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter
document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchMusic();
    }
});

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ø—É–ª—è—Ä–Ω—É—é –º—É–∑—ã–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', loadPopularMusic);
</script>
{% endblock %}