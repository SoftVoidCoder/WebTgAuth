<script>
// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ø—É–ª—è—Ä–Ω–æ–π –º—É–∑—ã–∫–∏
async function loadPopularMusic() {
    try {
        const container = document.getElementById('popularMusic');
        container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ø—É–ª—è—Ä–Ω–æ–π –º—É–∑—ã–∫–∏...</div>';
        
        const response = await fetch('/music/popular');
        const data = await response.json();
        
        if (data.results.length === 0) {
            container.innerHTML = '<div class="no-results">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º—É–∑—ã–∫—É</div>';
            return;
        }
        
        let html = '';
        data.results.forEach(song => {
            html += createSongCard(song);
        });
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading popular music:', error);
        document.getElementById('popularMusic').innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º—É–∑—ã–∫–∏</div>';
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç—Ä–µ–∫–∞
function createSongCard(song) {
    const safeTitle = song.title.replace(/"/g, '\\"');
    const safeArtist = song.artist.replace(/"/g, '\\"');
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
    const fileSize = song.file_size ? formatFileSize(song.file_size) : '';
    
    return `
        <div class="song-card" onclick="playSong('${song.id}', '${safeArtist}', '${safeTitle}')">
            <div class="song-image">
                ${song.thumbnail ? 
                    `<img src="${song.thumbnail}" alt="${song.title}" class="song-thumbnail">` :
                    `<div class="song-placeholder">üéµ</div>`
                }
            </div>
            <div class="song-info">
                <h3 class="song-title">${song.title}</h3>
                <p class="song-artist">${song.artist}</p>
                <div class="song-meta">
                    <span class="duration">${formatDuration(song.duration)}</span>
                    ${fileSize ? `<span class="file-size">${fileSize}</span>` : ''}
                    ${song.downloads ? `<span class="downloads">‚¨áÔ∏è ${song.downloads}</span>` : ''}
                </div>
            </div>
            <button class="play-btn">‚ñ∂</button>
        </div>
    `;
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
function formatFileSize(bytes) {
    if (!bytes) return '';
    const mb = bytes / (1024 * 1024);
    return mb.toFixed(1) + ' MB';
}

// –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ
function formatDuration(seconds) {
    if (!seconds) return '--:--';
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

// –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –º—É–∑—ã–∫–∏
function playSong(itemId, artist, title) {
    const audioPlayer = document.getElementById('audioPlayer');
    const audioElement = document.getElementById('audioElement');
    const nowPlaying = document.getElementById('nowPlaying');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–µ–µ—Ä
    audioPlayer.style.display = 'block';
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –º—É–∑—ã–∫–∏ (–ü–û–õ–ù–´–ô –¢–†–ï–ö)
    audioElement.src = `/music/stream/${itemId}`;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –∏–≥—Ä–∞–µ—Ç
    nowPlaying.textContent = `–°–µ–π—á–∞—Å –∏–≥—Ä–∞–µ—Ç: ${artist} - ${title}`;
    
    // –ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
    audioElement.play().catch(e => console.log('Autoplay blocked:', e));
}

// –ü–æ–∏—Å–∫ –º—É–∑—ã–∫–∏
async function searchMusic() {
    const query = document.getElementById('searchInput').value;
    if (!query) return;
    
    const resultsDiv = document.getElementById('searchResults');
    const searchSection = document.getElementById('searchSection');
    
    resultsDiv.innerHTML = '<div class="loading">–ò—â–µ–º –º—É–∑—ã–∫—É...</div>';
    searchSection.style.display = 'block';
    
    try {
        const response = await fetch(`/music/search?query=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        if (data.results.length === 0) {
            resultsDiv.innerHTML = '<div class="no-results">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
            return;
        }
        
        let html = '';
        data.results.forEach(song => {
            html += createSongCard(song);
        });
        
        resultsDiv.innerHTML = html;
        
    } catch (error) {
        console.error('Search error:', error);
        resultsDiv.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
    }
}

// –ü–æ–∏—Å–∫ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter
document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchMusic();
    }
});

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ø—É–ª—è—Ä–Ω—É—é –º—É–∑—ã–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', loadPopularMusic);
</script>