{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="/static/css/home.css">
<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
{% endblock %}

{% block content %}
<section class="hero">
    <h1>–£–ø—Ä–∞–≤–ª—è–π —Å–≤–æ–∏–º –∫—Ä–∏–ø—Ç–æ-–ø–æ—Ä—Ç—Ñ–µ–ª–µ–º</h1>
    <p>–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Å–≤–æ–∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏, –ø–æ–ª—É—á–∞–π—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –∏ –±—É–¥—å—Ç–µ –≤ –∫—É—Ä—Å–µ —Ä—ã–Ω–æ—á–Ω—ã—Ö —Ç–µ–Ω–¥–µ–Ω—Ü–∏–π</p>
    
    {% if not user_data %}
        <div style="margin-top: 2rem;">
            <p style="margin-bottom: 1rem; color: #b0b0b0;">–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Telegram —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</p>
        </div>
    {% else %}
        <div style="margin-top: 2rem;">
            <p style="color: #00c6ff;">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ user_data.first_name }}! üöÄ</p>
        </div>
    {% endif %}
</section>

<section class="crypto-section">
    <h2 class="section-title">–¢–æ–ø –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã</h2>
    
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≥—Ä–∞—Ñ–∏–∫–∞–º -->
    <div class="chart-navigation">
        <button class="chart-nav-btn active" data-symbol="BINANCE:BTCUSDT">BTC/USDT</button>
        <button class="chart-nav-btn" data-symbol="BINANCE:ETHUSDT">ETH/USDT</button>
        <button class="chart-nav-btn" data-symbol="BINANCE:TONUSDT">TON/USDT</button>
    </div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫ -->
    <div class="main-chart-container">
        <div id="tradingview_chart"></div>
    </div>
    
    <!-- –ë—ã—Å—Ç—Ä—ã–π –æ–±–∑–æ—Ä –º–æ–Ω–µ—Ç -->
    <div class="crypto-overview">
        <div class="crypto-card" data-symbol="BINANCE:BTCUSDT">
            <div class="crypto-info">
                <img src="https://cryptologos.cc/logos/bitcoin-btc-logo.png" alt="BTC" class="crypto-icon">
                <div class="crypto-details">
                    <h3>Bitcoin</h3>
                    <span class="crypto-symbol">BTC/USDT</span>
                </div>
            </div>
            <div class="crypto-price">
                <span class="price" id="btc-price">-</span>
                <span class="change" id="btc-change">-</span>
            </div>
        </div>
        
        <div class="crypto-card" data-symbol="BINANCE:ETHUSDT">
            <div class="crypto-info">
                <img src="https://cryptologos.cc/logos/ethereum-eth-logo.png" alt="ETH" class="crypto-icon">
                <div class="crypto-details">
                    <h3>Ethereum</h3>
                    <span class="crypto-symbol">ETH/USDT</span>
                </div>
            </div>
            <div class="crypto-price">
                <span class="price" id="eth-price">-</span>
                <span class="change" id="eth-change">-</span>
            </div>
        </div>
        
        <div class="crypto-card" data-symbol="BINANCE:TONUSDT">
            <div class="crypto-info">
                <img src="https://cryptologos.cc/logos/toncoin-ton-logo.png" alt="TON" class="crypto-icon">
                <div class="crypto-details">
                    <h3>Toncoin</h3>
                    <span class="crypto-symbol">TON/USDT</span>
                </div>
            </div>
            <div class="crypto-price">
                <span class="price" id="ton-price">-</span>
                <span class="change" id="ton-change">-</span>
            </div>
        </div>
    </div>
</section>

<script>
// –¢–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫
let currentChart = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TradingView –≥—Ä–∞—Ñ–∏–∫–∞
function initTradingView(symbol = 'BINANCE:BTCUSDT') {
    if (currentChart) {
        currentChart.remove();
    }
    
    new TradingView.widget({
        "autosize": true,
        "symbol": symbol,
        "interval": "15",
        "timezone": "Europe/Moscow",
        "theme": "dark",
        "style": "1",
        "locale": "ru",
        "toolbar_bg": "#0f0f0f",
        "enable_publishing": false,
        "allow_symbol_change": false,
        "container_id": "tradingview_chart",
        "studies": [
            "RSI@tv-basicstudies",
            "MACD@tv-basicstudies"
        ],
        "show_popup_button": true,
        "popup_width": "1000",
        "popup_height": "650"
    });
    
    currentChart = symbol;
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Ü–µ–Ω –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
async function loadRealTimePrices() {
    try {
        const response = await fetch('/crypto/prices');
        const data = await response.json();
        
        data.cryptos.forEach(crypto => {
            const priceElement = document.getElementById(`${crypto.symbol.toLowerCase()}-price`);
            const changeElement = document.getElementById(`${crypto.symbol.toLowerCase()}-change`);
            
            if (priceElement && changeElement) {
                priceElement.textContent = `$${crypto.current_price.toLocaleString()}`;
                
                const change = crypto.price_change_percentage_24h;
                changeElement.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
                changeElement.className = `change ${change >= 0 ? 'positive' : 'negative'}`;
            }
        });
        
    } catch (error) {
        console.error('Error loading prices:', error);
    }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
document.addEventListener('DOMContentLoaded', function() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≥—Ä–∞—Ñ–∏–∫ BTC –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    initTradingView('BINANCE:BTCUSDT');
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ü–µ–Ω—ã
    loadRealTimePrices();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—ã –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    setInterval(loadRealTimePrices, 30000);
    
    // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –≥—Ä–∞—Ñ–∏–∫–∞–º
    document.querySelectorAll('.chart-nav-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.chart-nav-btn').forEach(b => b.classList.remove('active'));
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Ç–µ–∫—É—â–µ–π –∫–Ω–æ–ø–∫–µ
            this.classList.add('active');
            // –ú–µ–Ω—è–µ–º –≥—Ä–∞—Ñ–∏–∫
            initTradingView(this.dataset.symbol);
        });
    });
    
    // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ –∫—Ä–∏–ø—Ç—ã
    document.querySelectorAll('.crypto-card').forEach(card => {
        card.addEventListener('click', function() {
            const symbol = this.dataset.symbol;
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–Ω–æ–ø–∫—É
            document.querySelectorAll('.chart-nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.symbol === symbol);
            });
            // –ú–µ–Ω—è–µ–º –≥—Ä–∞—Ñ–∏–∫
            initTradingView(symbol);
        });
    });
});
</script>
{% endblock %}